# Automatically generated by ansible 'kinderops-lnmp' role.
# Ansible managed! Do not modify - all changed will be overwritten by playbook!
{% if vhost.vhost_add_www == true %}
    {% set nginx_server_name = vhost.vhost_name ~ " www." ~  vhost.vhost_name %}
{% else %}
    {% set nginx_server_name = vhost.vhost_name %}
{% endif %}
server {
    listen 443 ssl http2;
    server_name {{ nginx_server_name }};
    ssl on;
    ssl_certificate /etc/letsencrypt/certs/fullchain_{{ vhost.vhost_name }}.crt;
    ssl_certificate_key /etc/letsencrypt/keys/{{ vhost.vhost_name }}.key;
    set $root_path /var/www/{{ vhost.vhost_name }}/html;
    index index.php index.html index.htm;
    disable_symlinks if_not_owner from=$root_path;
    access_log /var/log/nginx-access-{{ vhost.vhost_name }}.log;
    error_log /var/log/nginx-error-{{ vhost.vhost_name }}.log warn;
    ssi on;
    root $root_path;

    error_page   500 502 503 504  /50x.html;

    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    location ~ /\.ht {
        access_log off;
        log_not_found off;
        deny all;
     }

    location / {
        expires           360d;
    }

    location ~* \.php$ {
        try_files $uri $uri/ /index.php last;
        fastcgi_split_path_info  (.+?\.php)(/.*)$;
        fastcgi_pass unix:/var/run/php-fpm-{{ vhost.vhost_name }}.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }
}
server {
    listen 80;
    server_name _ {{ nginx_server_name }};
    return 301 https://$host$request_uri;
}